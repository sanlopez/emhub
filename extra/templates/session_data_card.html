{% import "entry_macros.html" as macros %}

<div class="col-12">
        <div class="card"> <!-- Data Card -->
            <div class="card-header">
                <h3 class="card-header-title"> Data </h3>
            </div>

            <div class="card-body">
                {% set stats = session.stats %}
                {% set extra = session.extra %}
                {% set otf_path = extra.get('otf', {}).get('path', '') %}
                <table class="table table-striped table-bordered">
                    <tbody>
                        {{ macros.trow('Raw path', extra['raw']['path']) }}
                        {{ macros.trow('OTF path', otf_path) }}
                        {{ macros.trow('Size', session.size|pretty_size) }}
                        {{ macros.trow('Files', session.total_files) }}
                        {{ macros.trow('Updated', extra.get('updated', '')) }}
                    </tbody>
                </table>
                 <div class="col-12">
                    <div id="files-pie" class="col-12"></div>
                </div>
            </div>
        </div> <!-- End of Data Card -->

        {% set raw_irods = extra.get('raw', {}).get('irods', '') %}
        {% set otf_irods = extra.get('otf', {}).get('irods', '') %}

        {% if raw_irods or otf_irods %}
            <div class="card"> <!-- Data Sharing Card -->
                <div class="card-header">
                    <h3 class="card-header-title"> Data Sharing</h3>
                </div>
                <h4 class="col-12 text-sm-left col-form-label ">More instructions on how to retrieve the data at this <a href="https://github.com/fjchichon/Guides/wiki/Download-RAWDATA-and-ScipionProject" class="badge badge-info mr-1 mt-1"> link</a></h4>
                <div class="col-xl-9 col-lg-9 col-md-9 col-sm-9 col-9">
                    <button type="button" id="booking-btn-ok" class="btn btn-primary" onclick="onSendEmailClick()">Send email to user</button>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered">
                        <tbody>
                            {{ macros.trow('Raw share command (linux)', raw_irods['linux']) }}
                            {{ macros.trow('Raw share command (windows)', raw_irods['windows']) }}
                            {{ macros.trow('OTF share command (linux)', otf_irods['linux']) }}
                            {{ macros.trow('OTF share command (windows)', otf_irods['windows']) }}
                        </tbody>
                    </table>
                     <div class="col-12">
                        <div id="files-pie" class="col-12"></div>
                    </div>
                </div>
            </div> <!-- End of Data Sharing Card -->
        {% endif %}

    </div>

<script>
    function onSendEmailClick(){
        var attrs = {
            session_id: {{ session.id }}
        }
        var ajaxContent = $.ajax({
            url: "{{ url_for('api.send_data_sharing_mail') }}",
            type: "POST",
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({attrs: attrs}),
            dataType: "json"
        });


        ajaxContent.done(function(jsonResponse) {
            //alert(JSON.stringify(jsonResponse, null, 4));

            if ('error' in jsonResponse)
                showError(jsonResponse['error']);
            else {
                showMessage('SUCCESS', 'Instructions about how to download the data has been sent to user email.');
            }
        });

        ajaxContent.fail(function(jqXHR, textStatus) {
            alert( "Request failed: " + textStatus );
        });
    }



    (function(window, document, $, undefined) {
        "use strict";
        $(function() {
            var filesData = {{ files|tojson }};
            create_hc_files_pie('files-pie', filesData);
        });
    })(window, document, window.jQuery);

</script>